<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Galentineâ€™s Launch ğŸ’–ğŸš€</title>

<style>
:root{
--hot:#ff1fb8;
--hot2:#ff4fd0;
--pink:#ff7bd6;
--baby:#ffd0ee;
--lav:#f2d7ff;
--ink:#240617;

--glass: rgba(255,255,255,.28);
--card: rgba(255,255,255,.68);

--shadowA: 0 26px 90px rgba(255,31,184,.38);
--shadowB: 0 16px 36px rgba(0,0,0,.18);
--shadowC: 0 18px 0 rgba(140,0,90,.16);
--r: 28px;

--safeTop: env(safe-area-inset-top);
--safeBot: env(safe-area-inset-bottom);
--vh: 100vh;
}

*{box-sizing:border-box}
html,body{
height: var(--vh);
margin:0;
overflow:hidden; /* lock the page; internal scroll only */
}
body{
font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
color:var(--ink);
background:
radial-gradient(1100px 800px at 18% 8%, rgba(255,255,255,.90) 0%, transparent 55%),
radial-gradient(900px 700px at 82% 16%, rgba(255,255,255,.80) 0%, transparent 55%),
radial-gradient(900px 650px at 30% 85%, rgba(255,255,255,.55) 0%, transparent 55%),
linear-gradient(135deg, var(--lav), var(--baby) 30%, var(--pink) 65%, var(--hot2));
}

/* overlays must NOT block taps */
.pattern,.floaters,.fx{ pointer-events:none; }

.pattern{
position:fixed; inset:0; z-index:0;
opacity:.26;
background-image:
radial-gradient(circle at 20% 30%, rgba(255,255,255,.95) 0 1.5px, transparent 2px),
radial-gradient(circle at 78% 22%, rgba(255,255,255,.9) 0 1.5px, transparent 2px),
radial-gradient(circle at 38% 72%, rgba(255,255,255,.85) 0 1.5px, transparent 2px),
radial-gradient(circle at 88% 80%, rgba(255,255,255,.9) 0 1.5px, transparent 2px);
background-size: 260px 260px;
}

.floaters{ position:fixed; inset:0; z-index:0; }
.blob{
position:absolute;
width: 320px; height: 320px;
border-radius: 100px;
background:
radial-gradient(140px 140px at 28% 26%, rgba(255,255,255,.95) 0%, rgba(255,255,255,.18) 60%, rgba(255,255,255,0) 72%),
radial-gradient(160px 160px at 70% 75%, rgba(255,255,255,.35) 0%, rgba(255,255,255,0) 62%),
linear-gradient(135deg, rgba(255,31,184,.56), rgba(255,255,255,.22));
border: 1px solid rgba(255,255,255,.65);
box-shadow: 0 44px 130px rgba(0,0,0,.14), 0 26px 90px rgba(255,31,184,.20);
filter: saturate(1.15);
animation: drift 10s ease-in-out infinite;
}
.b1{ left:-140px; top:70px; transform: rotate(12deg); animation-duration: 12s; }
.b2{ right:-170px; top:160px; width: 380px; height:380px; border-radius: 120px; transform: rotate(-10deg); animation-duration: 14s; }
.b3{ left:40px; bottom:-210px; width: 460px; height:460px; border-radius: 150px; transform: rotate(8deg); animation-duration: 16s; }
@keyframes drift{ 0%,100%{ translate: 0 0; } 50%{ translate: 0 -22px; } }

.app{
position:relative;
z-index:1;
height: var(--vh);
display:flex;
flex-direction:column;
padding-top: calc(10px + var(--safeTop));
padding-bottom: calc(10px + var(--safeBot));
min-height:0; /* KEY for iOS */
}

.topbar{
display:flex;
align-items:center;
justify-content:space-between;
gap:10px;
padding: 10px 14px;
flex:0 0 auto;
}

.chip{
display:inline-flex; align-items:center; gap:8px;
padding:10px 14px;
border-radius:999px;
background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.58));
border: 1px solid rgba(255,255,255,.72);
box-shadow: 0 14px 30px rgba(0,0,0,.10), 0 18px 50px rgba(255,31,184,.18);
font-weight: 1000;
user-select:none;
}

.soundBtn{
display:inline-flex; align-items:center; gap:8px;
padding:10px 14px;
border-radius:999px;
border: 1px solid rgba(255,255,255,.72);
background: linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.54));
box-shadow: 0 14px 30px rgba(0,0,0,.10);
font-weight:1000;
cursor:pointer;
user-select:none;
}
.soundDot{
width:10px; height:10px; border-radius:999px;
background: rgba(0,0,0,.22);
box-shadow: 0 0 0 6px rgba(255,31,184,.14);
}
.soundOn .soundDot{ background: #17ff7a; box-shadow: 0 0 0 6px rgba(23,255,122,.16); }

.viewport{
flex:1 1 auto;
min-height:0; /* KEY */
overflow:hidden; /* only internal containers scroll */
padding: 10px 14px;
}

.track{
height:100%;
display:flex;
gap:14px;
overflow-x:auto;
overflow-y:hidden;
scroll-snap-type: x mandatory;
-webkit-overflow-scrolling: touch;
scroll-behavior:smooth;
align-items:stretch;
touch-action: pan-x;
padding-bottom: 10px;
}
.track::-webkit-scrollbar{ display:none; }

/* âœ… BIG FIX:
slide does NOT scroll; the card scrolls (stable on iOS) */
.slide{
flex: 0 0 100%;
scroll-snap-align: center;
height:100%;
min-height:0;
display:flex;
flex-direction:column;
overflow:hidden;
}

/* card is the vertical scroll container */
.card{
flex:1 1 auto;
min-height:0;
overflow-y:auto;
-webkit-overflow-scrolling: touch;

position:relative;
background: var(--card);
border: 1px solid rgba(255,255,255,.72);
border-radius: var(--r);
box-shadow: var(--shadowA);
padding: 18px;
}

h1{
margin:0;
font-size: clamp(34px, 7vw, 56px);
line-height:1.02;
letter-spacing:-.9px;
text-shadow: 0 2px 0 rgba(255,255,255,.55);
}
.sub{
margin:10px 0 0;
font-size: 16px;
line-height:1.55;
opacity:.95;
max-width: 60ch;
}

.stage{
position:relative;
min-height: 260px;
margin-top: 14px;
border-radius: 24px;
background:
radial-gradient(240px 140px at 25% 18%, rgba(255,255,255,.45), transparent 60%),
radial-gradient(320px 220px at 85% 75%, rgba(255,255,255,.24), transparent 65%),
linear-gradient(135deg, rgba(255,255,255,.32), rgba(255,255,255,.12));
border: 1px solid rgba(255,255,255,.52);
box-shadow: var(--shadowB);
overflow:hidden;
}

.neon{
position:absolute;
left:-20%;
top:22%;
width:160%;
height:28px;
transform: rotate(-10deg);
background: linear-gradient(90deg, transparent, rgba(23,255,122,.8), transparent);
opacity:.40;
}

.asset{
position:absolute;
width: 150px;
height:auto;
filter: drop-shadow(0 22px 28px rgba(0,0,0,.22));
animation: floatA 6.6s ease-in-out infinite;
user-select:none;
pointer-events:none;
}
.asset.small{ width: 96px; animation-duration: 7.4s; }
.asset.tiny{ width: 70px; animation-duration: 8.1s; }
@keyframes floatA{ 0%,100%{ translate:0 0; } 50%{ translate:0 -14px; } }

.a-hero{ left: 50%; top: 50%; transform: translate(-50%,-50%); width: 190px; animation-duration: 6.2s; }
.a-radio{ left: 10%; top: 56%; width: 130px; animation-duration: 7.2s; }
.a-cd1{ left: 68%; top: 18%; width: 120px; animation-duration: 7.8s; }
.a-cd2{ left: 16%; top: 16%; width: 90px; animation-duration: 8.2s; }
.a-heart{ left: 76%; top: 62%; width: 90px; animation-duration: 6.8s; }
.a-star{ left: 38%; top: 10%; width: 76px; animation-duration: 7.1s; }
.a-flower{ left: 6%; top: 70%; width: 86px; animation-duration: 8.6s; }

.pills{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 12px; }
.pill{
padding:10px 12px;
border-radius:999px;
font-weight:1100;
font-size:14px;
background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.58));
border: 1px solid rgba(255,255,255,.75);
box-shadow: var(--shadowB);
}

.btnRow{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 14px; }

.btn3d{
display:inline-flex; align-items:center; justify-content:center; gap:10px;
padding:14px 16px;
border-radius: 18px;
text-decoration:none;
font-weight: 1200;
border: 1px solid rgba(255,255,255,.55);
box-shadow: var(--shadowC), 0 18px 45px rgba(0,0,0,.16);
background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.62));
color: var(--ink);
cursor:pointer;
user-select:none;
}
.btn3d.primary{
color:#fff;
background:
radial-gradient(180px 90px at 25% 20%, rgba(255,255,255,.35), transparent 55%),
linear-gradient(180deg, var(--hot), var(--hot2));
}
.btn3d.chrome{
color:#240617;
background:
radial-gradient(160px 90px at 22% 18%, rgba(255,255,255,.95), transparent 58%),
radial-gradient(220px 120px at 80% 78%, rgba(255,255,255,.55), transparent 65%),
linear-gradient(135deg, rgba(230,230,255,.95), rgba(255,255,255,.65) 35%, rgba(255,120,214,.25) 70%, rgba(180,255,220,.35));
border: 1px solid rgba(255,255,255,.85);
box-shadow: 0 18px 0 rgba(140,0,90,.12), 0 18px 45px rgba(0,0,0,.16);
}

.countdown{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:12px; }
.timebox{
border-radius: 18px;
padding: 12px 10px;
text-align:center;
background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.62));
border: 1px solid rgba(255,255,255,.78);
box-shadow: var(--shadowB);
}
.num{ font-size: 24px; font-weight: 1300; letter-spacing:-.4px; }
.lab{ font-size:12px; font-weight: 1100; opacity:.86; letter-spacing:.9px; text-transform:uppercase; margin-top:3px; }

.sectionTitle{
margin: 12px 0 8px;
font-size: 18px;
font-weight: 1300;
letter-spacing:-.2px;
}
.options{ display:flex; flex-wrap:wrap; gap:10px; }

.opt{
display:inline-flex;
align-items:center;
gap:10px;
padding: 12px 14px;
border-radius: 999px;
background:
radial-gradient(160px 90px at 30% 20%, rgba(255,255,255,.55), transparent 55%),
linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.60));
border: 1px solid rgba(255,255,255,.78);
box-shadow: 0 16px 0 rgba(120,0,80,.12), var(--shadowB);
font-weight: 1200;
cursor:pointer;
user-select:none;
}
.opt[data-on="1"]{
outline: 3px solid rgba(23,255,122,.45);
box-shadow: 0 16px 0 rgba(23,255,122,.16), 0 18px 45px rgba(0,0,0,.16);
}

label.small{ display:block; margin: 10px 0 6px; font-weight:1300; }
input.text, textarea.text{
width:100%;
border-radius: 18px;
border: 1px solid rgba(255,255,255,.78);
padding: 12px 12px;
font-size: 15px;
background: rgba(255,255,255,.82);
box-shadow: var(--shadowB);
outline:none;
}
textarea.text{ min-height: 96px; resize: vertical; }

.nav{
padding: 4px 14px 10px;
display:flex;
gap:10px;
align-items:center;
justify-content:space-between;
flex:0 0 auto;
}
.dots{ display:flex; gap:8px; align-items:center; }
.dot{
width:10px; height:10px; border-radius:999px;
background: rgba(255,255,255,.55);
border: 1px solid rgba(255,255,255,.75);
box-shadow: 0 10px 18px rgba(0,0,0,.10);
}
.dot.on{ background: rgba(23,255,122,.85); }

.loading{
position:fixed; inset:0; z-index:50;
display:flex; flex-direction:column; align-items:center; justify-content:center;
gap:14px;
background:
radial-gradient(900px 700px at 20% 10%, rgba(255,255,255,.85) 0%, transparent 55%),
linear-gradient(135deg, var(--lav), var(--baby) 30%, var(--pink) 65%, var(--hot2));
}
.loadCard{
width:min(520px, 92vw);
border-radius: 30px;
padding: 18px;
background: rgba(255,255,255,.62);
border: 1px solid rgba(255,255,255,.76);
box-shadow: var(--shadowA);
text-align:center;
}
.loadTitle{ font-size: 28px; font-weight: 1400; margin: 0; }
.loadSub{ margin: 8px 0 0; opacity:.92; font-weight: 1100; }
.bar{
margin: 14px auto 0;
height: 14px;
width: 100%;
border-radius: 999px;
background: rgba(255,255,255,.55);
border: 1px solid rgba(255,255,255,.76);
overflow:hidden;
box-shadow: var(--shadowB);
}
.bar > i{
display:block;
height:100%;
width: 35%;
border-radius: 999px;
background: linear-gradient(90deg, rgba(23,255,122,.85), rgba(255,31,184,.85));
animation: loadMove 1.05s ease-in-out infinite;
}
@keyframes loadMove{
0%{ transform: translateX(-20%); width: 30%; }
50%{ transform: translateX(65%); width: 45%; }
100%{ transform: translateX(-20%); width: 30%; }
}

.resultsGrid{ display:grid; gap:10px; }
.meter{
border-radius: 18px;
padding: 12px;
background: rgba(255,255,255,.78);
border: 1px solid rgba(255,255,255,.82);
box-shadow: var(--shadowB);
}
.meterTop{ display:flex; justify-content:space-between; gap:10px; align-items:baseline; font-weight:1300; }
.meterTop small{ opacity:.85; font-weight:1100; }
.rail{
margin-top:10px;
height: 16px;
border-radius: 999px;
background: rgba(0,0,0,.08);
overflow:hidden;
border: 1px solid rgba(255,255,255,.65);
}
.fill{
height:100%;
width:0%;
border-radius: 999px;
background: linear-gradient(90deg, rgba(23,255,122,.85), rgba(255,31,184,.85));
transition: width 520ms ease;
}
.tinyNote{ margin-top:10px; opacity:.92; font-weight:1100; }

@media (max-height: 720px){
.topbar { padding: 8px 12px; }
.btnRow { margin-top: 10px; }
.stage { min-height: 220px; }
}
</style>
</head>

<body>
<div class="pattern" aria-hidden="true"></div>
<div class="floaters" aria-hidden="true">
<div class="blob b1"></div>
<div class="blob b2"></div>
<div class="blob b3"></div>
</div>

<div class="loading" id="loading">
<div class="loadCard">
<h2 class="loadTitle">Launching Galentineâ€™sâ€¦ ğŸ’–ğŸš€</h2>
<div class="loadSub">Loading the drop: chrome + CDs + chaos</div>
<div class="bar"><i></i></div>
</div>
</div>

<div class="app">
<div class="topbar">
<div class="chip">ğŸ’¿ Galentineâ€™s Launch</div>
<button class="soundBtn" id="soundBtn" type="button">
<span class="soundDot" aria-hidden="true"></span>
<span id="soundLabel">Sound: Off</span>
</button>
</div>

<div class="viewport">
<div class="track" id="track">

<!-- Slide 1 -->
<section class="slide">
<div class="card">
<h1>Valentineâ€™s Day<br>for the Girlies ğŸ’˜</h1>
<p class="sub">This is a limited drop. If youâ€™re coming, say it with your chest. ğŸ’…</p>

<div class="stage">
<div class="neon"></div>

<img class="asset a-hero" src="assets/hero-phone.png" alt="" />
<img class="asset a-radio" src="assets/radio.png" alt="" />
<img class="asset a-cd1" src="assets/cd1.png" alt="" />
<img class="asset small a-cd2" src="assets/cd2.png" alt="" />
<img class="asset small a-heart" src="assets/chrome-heart.png" alt="" />
<img class="asset tiny a-star" src="assets/star.png" alt="" />
<img class="asset tiny a-flower" src="assets/flower.png" alt="" />
</div>

<div class="btnRow">
<button class="btn3d primary" type="button" id="startBtn">Tap to Enter ğŸ’–</button>
<button class="btn3d" type="button" id="peekBtn">Peek the Deets ğŸ‘€</button>
</div>
</div>
</section>

<!-- Slide 2 -->
<section class="slide">
<div class="card">
<h1>The Deets âœ¨</h1>
<p class="sub">Bring something homemade or bought. Either way, bring your best energy.</p>

<div class="pills">
<div class="pill">ğŸ“… Feb 13</div>
<div class="pill">ğŸ•‘ 2:00 PM</div>
<div class="pill">ğŸ“ Jersey City</div>
<div class="pill">ğŸ“ Potluck / Buy-luck</div>
</div>

<div class="sectionTitle" style="margin-top:14px;">Countdown â³</div>
<div class="countdown">
<div class="timebox"><div class="num" id="dd">--</div><div class="lab">Days</div></div>
<div class="timebox"><div class="num" id="hh">--</div><div class="lab">Hours</div></div>
<div class="timebox"><div class="num" id="mm">--</div><div class="lab">Min</div></div>
<div class="timebox"><div class="num" id="ss">--</div><div class="lab">Sec</div></div>
</div>

<div class="btnRow">
<a class="btn3d chrome"
href="https://open.spotify.com/playlist/15r9CUj51Xte5bt5ctVj8l?si=R99FGXYPTcaUEtyFsM11SQ&pi=uaBWm0O1SMWq5"
target="_blank" rel="noopener">ğŸ§ Galentineâ€™s Playlist</a>
</div>

<div class="btnRow">
<button class="btn3d primary" type="button" id="toVote">Next: Vote ğŸ’¿</button>
<button class="btn3d" type="button" id="back1">Back</button>
</div>
</div>
</section>

<!-- Slide 3 -->
<section class="slide">
<div class="card">
<h1>Vote Like a Popstar ğŸ¤</h1>
<p class="sub">Tap choices. They should feel like stickersâ€”because they are.</p>

<div class="sectionTitle">Activity (pick any)</div>
<div class="options">
<div class="opt" data-type="check" data-name="activity" data-value="Brunch">ğŸ³ Brunch</div>
<div class="opt" data-type="check" data-name="activity" data-value="Karaoke">ğŸ¤ Karaoke</div>
<div class="opt" data-type="check" data-name="activity" data-value="Spa">ğŸ§–â€â™€ï¸ Spa</div>
<div class="opt" data-type="check" data-name="activity" data-value="Game night">ğŸ² Game night</div>
</div>

<div class="sectionTitle">Drinks (pick one)</div>
<div class="options">
<div class="opt" data-type="radio" data-name="drinks" data-value="Mocktails">ğŸ“ Mocktails</div>
<div class="opt" data-type="radio" data-name="drinks" data-value="Cocktails">ğŸ¥‚ Cocktails</div>
<div class="opt" data-type="radio" data-name="drinks" data-value="Both">âœ¨ Both</div>
</div>

<div class="sectionTitle">Outfit / Theme (pick any)</div>
<div class="options">
<div class="opt" data-type="check" data-name="outfit" data-value="All pink everything">ğŸ’– All pink</div>
<div class="opt" data-type="check" data-name="outfit" data-value="Red + pink">ğŸ’‹ Red + pink</div>
<div class="opt" data-type="check" data-name="outfit" data-value="Cozy slay">ğŸ§¸ Cozy slay</div>
<div class="opt" data-type="check" data-name="outfit" data-value="Y2K glam">ğŸ’¿ Y2K glam</div>
</div>

<div class="btnRow">
<button class="btn3d primary" type="button" id="toExtras">Next: Extras âœ¨</button>
<button class="btn3d" type="button" id="back2">Back</button>
</div>
</div>
</section>

<!-- Slide 4 -->
<section class="slide">
<div class="card">
<h1>Extras ğŸ˜‡</h1>
<p class="sub">Be honest. Are you bringing a +1? And what are you contributing to the snack economy?</p>

<label class="small">Plus one?</label>
<div class="options">
<div class="opt" data-type="radio" data-name="plusone" data-value="No plus one">No +1</div>
<div class="opt" data-type="radio" data-name="plusone" data-value="Yes +1">Yes +1</div>
</div>

<label class="small" for="bring">What are you bringing?</label>
<input class="text" id="bring" type="text" placeholder="cupcakes / chips / fruit / drinks / vibes" />

<label class="small" for="notes">Notes / allergies / song request</label>
<textarea class="text" id="notes" placeholder="Drop the tea hereâ€¦ respectfully."></textarea>

<div class="btnRow">
<button class="btn3d primary" type="button" id="toRsvp">Next: RSVP ğŸ’Œ</button>
<button class="btn3d" type="button" id="back3">Back</button>
</div>
</div>
</section>

<!-- Slide 5 -->
<section class="slide">
<div class="card">
<h1>RSVP ğŸ’Œ</h1>
<p class="sub">Submit it. Then check the live vote results like itâ€™s the Billboard charts.</p>

<label class="small" for="name">Your name *</label>
<input class="text" id="name" type="text" placeholder="Nia / Kayla / Queen ğŸ‘‘" />

<div class="sectionTitle">RSVP status *</div>
<div class="options">
<div class="opt" data-type="radio" data-name="status" data-value="Iâ€™m in ğŸ’–">Iâ€™m in ğŸ’–</div>
<div class="opt" data-type="radio" data-name="status" data-value="Maybe ğŸ¤">Maybe ğŸ¤</div>
<div class="opt" data-type="radio" data-name="status" data-value="Canâ€™t ğŸ˜­">Canâ€™t ğŸ˜­</div>
</div>

<div class="btnRow">
<button class="btn3d primary" type="button" id="submitBtn">Submit RSVP ğŸ’–</button>
<button class="btn3d" type="button" id="refreshResults">Refresh Results</button>
</div>

<div class="tinyNote" id="saveMsg" style="display:none;">Saved ğŸ’– If you change your mind, submit again.</div>

<div class="sectionTitle" style="margin-top:14px;">Live Results ğŸ“Š</div>
<div class="resultsGrid">
<div class="meter">
<div class="meterTop"><span>Total RSVPs</span><small id="totalCount">0</small></div>
<div class="rail"><div class="fill" id="totalFill"></div></div>
</div>
<div class="meter">
<div class="meterTop"><span>Top Activity</span><small id="topActivity">â€”</small></div>
<div class="rail"><div class="fill" id="activityFill"></div></div>
</div>
<div class="meter">
<div class="meterTop"><span>Top Drink</span><small id="topDrink">â€”</small></div>
<div class="rail"><div class="fill" id="drinksFill"></div></div>
</div>
<div class="meter">
<div class="meterTop"><span>Top Outfit</span><small id="topOutfit">â€”</small></div>
<div class="rail"><div class="fill" id="outfitFill"></div></div>
</div>
</div>

<div class="tinyNote" id="detailDump"></div>

<form id="hiddenForm"
method="POST"
action="https://script.google.com/macros/s/AKfycbzc_x8_hAQSXUCZnyyRHsVb_anqCFrO2NhV2NwaomycAAHL7t-sgfsErnzxaTmey9BpCw/exec"
target="sink"
style="display:none;">
<input name="name" id="f_name" />
<input name="status" id="f_status" />
<input name="availability" id="f_availability" />
<input name="drinks" id="f_drinks" />
<input name="plusone" id="f_plusone" />
<input name="bring" id="f_bring" />
<input name="notes" id="f_notes" />
<div id="checks"></div>
</form>
<iframe name="sink" style="display:none"></iframe>
</div>
</section>

</div>
</div>

<div class="nav">
<div class="dots" id="dots"></div>
<div class="chip" id="stepLabel">Step 1 / 5</div>
</div>
</div>

<script>
/* iOS real viewport height */
function setRealVH(){
document.documentElement.style.setProperty('--vh', `${window.innerHeight}px`);
}
setRealVH();
window.addEventListener('resize', setRealVH, {passive:true});
window.addEventListener('orientationchange', () => setTimeout(setRealVH, 250), {passive:true});

/* CONFIG */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzc_x8_hAQSXUCZnyyRHsVb_anqCFrO2NhV2NwaomycAAHL7t-sgfsErnzxaTmey9BpCw/exec";
let resultsLoading = false;
let lastResultsScript = null;
const EVENT_LOCAL = { month: 2, day: 13, hour: 14, minute: 0 };

/* LOADER â€” impossible to get stuck */
function hideLoader(){
const loading = document.getElementById("loading");
if(!loading) return;
loading.style.transition = "opacity 220ms ease";
loading.style.opacity = "0";
setTimeout(()=> loading.remove(), 260);
}
document.addEventListener("DOMContentLoaded", () => setTimeout(hideLoader, 700));
window.addEventListener("load", () => setTimeout(hideLoader, 900));
setTimeout(hideLoader, 1800);

/* SOUND */
/* SOUND â€” iOS-safe (unlocks audio reliably) */
let soundOn = false;

const soundBtn   = document.getElementById('soundBtn');
const soundLabel = document.getElementById('soundLabel');

let audioCtx = null;

async function ensureAudio(){
  try{
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended"){
      await audioCtx.resume();
    }
    return true;
  }catch(err){
    console.log("Audio blocked:", err);
    return false;
  }
}

function blip(freq=520, ms=70, type="sine", gain=0.05){
  if(!soundOn || !audioCtx) return;

  const t0 = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();

  o.type = type;
  o.frequency.setValueAtTime(freq, t0);

  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + ms/1000);

  o.connect(g);
  g.connect(audioCtx.destination);

  o.start(t0);
  o.stop(t0 + ms/1000);
}

// IMPORTANT: iOS sometimes ignores "click" but accepts pointer/touch.
// We'll use ONE handler for all.
async function toggleSound(e){
  e.preventDefault();

  const ok = await ensureAudio();
  if(!ok){
    // If audio is blocked, still toggle UI so user sees it tried
    soundOn = !soundOn;
  }else{
    soundOn = !soundOn;
  }

  soundBtn.classList.toggle('soundOn', soundOn);
  soundLabel.textContent = soundOn ? "Sound: On" : "Sound: Off";

  // little confirmation chirp
  if(soundOn){
    blip(420, 90, "sine", 0.06);
  }
}

// Use multiple event types for reliability
soundBtn.addEventListener('pointerdown', toggleSound, { passive:false });
soundBtn.addEventListener('touchstart', toggleSound, { passive:false });
soundBtn.addEventListener('click', toggleSound);

// Extra: if iOS suspends audio when switching tabs, re-resume on any tap
document.addEventListener('visibilitychange', () => {
  if(document.visibilityState === "visible" && soundOn){
    ensureAudio();
  }
});

function ensureAudio(){
if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
if(audioCtx.state === "suspended") audioCtx.resume();
}
function blip(freq=520, ms=60, type="sine", gain=0.045){
if(!soundOn) return;
ensureAudio();
const t0 = audioCtx.currentTime;
const o = audioCtx.createOscillator();
const g = audioCtx.createGain();
o.type = type;
o.frequency.value = freq;
g.gain.setValueAtTime(0.0001, t0);
g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
g.gain.exponentialRampToValueAtTime(0.0001, t0 + ms/1000);
o.connect(g).connect(audioCtx.destination);
o.start(t0);
o.stop(t0 + ms/1000);
}
soundBtn.addEventListener('click', () => {
soundOn = !soundOn;
soundBtn.classList.toggle('soundOn', soundOn);
soundLabel.textContent = soundOn ? "Sound: On" : "Sound: Off";
if(soundOn){ ensureAudio(); blip(420, 80, "sine", 0.05); }
});

/* NAV */
const track = document.getElementById('track');
const slides = Array.from(document.querySelectorAll('.slide'));
const dots = document.getElementById('dots');
const stepLabel = document.getElementById('stepLabel');

slides.forEach((_, i) => {
const d = document.createElement('div');
d.className = 'dot' + (i===0 ? ' on' : '');
dots.appendChild(d);
d.addEventListener('click', () => goTo(i));
});

function currentIndex(){
const w = track.clientWidth + 14;
return Math.round(track.scrollLeft / w);
}
function setUI(i){
Array.from(dots.children).forEach((el, idx) => el.classList.toggle('on', idx===i));
stepLabel.textContent = `Step ${i+1} / ${slides.length}`;
}
function goTo(i){
const w = track.clientWidth + 14;
track.scrollTo({ left: i * w, behavior: 'smooth' });
setUI(i);
// reset scroll inside the card so buttons show on small phones
const card = slides[i].querySelector('.card');
if(card) card.scrollTo({ top: 0, behavior: 'auto' });
}
track.addEventListener('scroll', () => setUI(currentIndex()), { passive:true });

document.getElementById('startBtn').addEventListener('click', () => goTo(1));
document.getElementById('peekBtn').addEventListener('click', () => goTo(1));
document.getElementById('toVote').addEventListener('click', () => goTo(2));
document.getElementById('toExtras').addEventListener('click', () => goTo(3));
document.getElementById('toRsvp').addEventListener('click', () => goTo(4));
document.getElementById('back1').addEventListener('click', () => goTo(0));
document.getElementById('back2').addEventListener('click', () => goTo(1));
document.getElementById('back3').addEventListener('click', () => goTo(2));

/* OPTIONS */
const state = {
activity: new Set(),
outfit: new Set(),
drinks: "",
plusone: "",
status: ""
};

function toggleOpt(el){
const type = el.dataset.type;
const name = el.dataset.name;
const val = el.dataset.value;

if(type === "check"){
const set = state[name];
if(set.has(val)){ set.delete(val); el.dataset.on="0"; blip(420); }
else{ set.add(val); el.dataset.on="1"; blip(740); }
}else{
state[name] = val;
const parent = el.parentElement;
Array.from(parent.querySelectorAll('.opt')).forEach(o => o.dataset.on = (o===el ? "1" : "0"));
blip(740);
}
}
document.querySelectorAll('.opt').forEach(el => {
el.dataset.on = "0";
el.addEventListener('click', () => toggleOpt(el));
});

/* COUNTDOWN */
const dd = document.getElementById('dd');
const hh = document.getElementById('hh');
const mm = document.getElementById('mm');
const ss = document.getElementById('ss');

function getTarget(){
const now = new Date();
const year = now.getFullYear();
const t = new Date(year, EVENT_LOCAL.month - 1, EVENT_LOCAL.day, EVENT_LOCAL.hour, EVENT_LOCAL.minute, 0);
return (t - now > 0) ? t : new Date(year + 1, EVENT_LOCAL.month - 1, EVENT_LOCAL.day, EVENT_LOCAL.hour, EVENT_LOCAL.minute, 0);
}
let target = getTarget();
function tick(){
const n = new Date();
let diff = target - n;
if(diff < 0){ target = getTarget(); diff = target - n; }
const d = Math.floor(diff / (1000*60*60*24)); diff -= d*(1000*60*60*24);
const h = Math.floor(diff / (1000*60*60)); diff -= h*(1000*60*60);
const m = Math.floor(diff / (1000*60)); diff -= m*(1000*60);
const s = Math.floor(diff / 1000);
dd.textContent=d; hh.textContent=h; mm.textContent=m; ss.textContent=s;
}
tick(); setInterval(tick, 1000);

/* SUBMIT RSVP */
const hiddenForm = document.getElementById('hiddenForm');
const checksDiv = document.getElementById('checks');
const saveMsg = document.getElementById('saveMsg');

function setHidden(id, val){ document.getElementById(id).value = val || ""; }

document.getElementById('submitBtn').addEventListener('click', () => {
const name = document.getElementById('name').value.trim();
if(!name){ alert("Put your name ğŸ˜­"); return; }
if(!state.status){ alert("Pick your RSVP status ğŸ’–"); return; }

setHidden('f_name', name);
setHidden('f_status', state.status);
setHidden('f_availability', "Feb 13 @ 2PM");
setHidden('f_drinks', state.drinks);
setHidden('f_plusone', state.plusone);
setHidden('f_bring', document.getElementById('bring').value.trim());
setHidden('f_notes', document.getElementById('notes').value.trim());

checksDiv.innerHTML = "";
for(const v of state.activity){
const i = document.createElement('input');
i.type="hidden"; i.name="activity"; i.value=v;
checksDiv.appendChild(i);
}
for(const v of state.outfit){
const i = document.createElement('input');
i.type="hidden"; i.name="outfit"; i.value=v;
checksDiv.appendChild(i);
}

hiddenForm.submit();
saveMsg.style.display = "block";
setTimeout(fetchResults, 800);
});

/* RESULTS (JSONP) */
const totalCount = document.getElementById('totalCount');
const totalFill = document.getElementById('totalFill');
const topActivity = document.getElementById('topActivity');
const topDrink = document.getElementById('topDrink');
const topOutfit = document.getElementById('topOutfit');
const activityFill= document.getElementById('activityFill');
const drinksFill = document.getElementById('drinksFill');
const outfitFill = document.getElementById('outfitFill');
const detailDump = document.getElementById('detailDump');

function topKey(obj){
let bestK="â€”", bestV=0;
for(const k in obj){ if(obj[k] > bestV){ bestV=obj[k]; bestK=k; } }
return {key: bestK, val: bestV};
}
function pct(n,total){ return (!total)?0:Math.round((n/total)*100); }

function renderResults(data){
const total = data.total || 0;
totalCount.textContent = String(total);
totalFill.style.width = Math.min(100, total*8) + "%";

const a = topKey(data.activity || {});
const d = topKey(data.drinks || {});
const o = topKey(data.outfit || {});

const aPct = pct(a.val,total), dPct = pct(d.val,total), oPct = pct(o.val,total);

topActivity.textContent = `${a.key} â€” ${a.val} (${aPct}%)`;
topDrink.textContent = `${d.key} â€” ${d.val} (${dPct}%)`;
topOutfit.textContent = `${o.key} â€” ${o.val} (${oPct}%)`;

activityFill.style.width = aPct + "%";
drinksFill.style.width = dPct + "%";
outfitFill.style.width = oPct + "%";

detailDump.textContent = total ? "Updated just now âœ…" : "No votes yet. Be the first icon. ğŸ’…";
}

function fetchResults(force = false){
  if(resultsLoading && !force) return; // prevent spam taps
  resultsLoading = true;

  // UI feedback
  detailDump.textContent = "Refreshingâ€¦";
  const refreshBtn = document.getElementById('refreshResults');
  if(refreshBtn){
    refreshBtn.disabled = true;
    refreshBtn.style.opacity = "0.7";
  }

  // kill previous JSONP script if still around
  try{
    if(lastResultsScript && lastResultsScript.parentNode){
      lastResultsScript.parentNode.removeChild(lastResultsScript);
    }
  }catch(e){}

  const cb = "cb_" + Math.random().toString(16).slice(2);
  const script = document.createElement('script');
  lastResultsScript = script;

  // hard timeout so it never hangs silently
  const timeout = setTimeout(() => {
    resultsLoading = false;
    if(refreshBtn){
      refreshBtn.disabled = false;
      refreshBtn.style.opacity = "";
    }
    detailDump.textContent = "Refresh timed out. Try again.";
    try{ script.remove(); }catch(e){}
    try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
  }, 6000);

  window[cb] = (data) => {
    clearTimeout(timeout);
    try{
      renderResults(data || {});
      detailDump.textContent = "Updated âœ…";
    }catch(err){
      detailDump.textContent = "Refresh failed. Check console.";
    }finally{
      resultsLoading = false;
      if(refreshBtn){
        refreshBtn.disabled = false;
        refreshBtn.style.opacity = "";
      }
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      try{ script.remove(); }catch(e){}
    }
  };

  // cache-bust ALWAYS
  const url = `${WEB_APP_URL}?action=results&callback=${cb}&t=${Date.now()}_${Math.random().toString(16).slice(2)}`;
  script.src = url;

  script.onerror = () => {
    clearTimeout(timeout);
    resultsLoading = false;
    if(refreshBtn){
      refreshBtn.disabled = false;
      refreshBtn.style.opacity = "";
    }
    detailDump.textContent = "Results couldnâ€™t load. Check Apps Script deployment.";
    try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
    try{ script.remove(); }catch(e){}
  };

  document.body.appendChild(script);
}

setTimeout(fetchResults, 900);
</script>
</body>
</html>
